{% extends "base.html" %} {% load static %} {% block title %}{{ title }}
{%endblock %} {% block extra_head %}
<style>
  #lostMapPicker {
    height: 500px;
    width: 100%;
    border-radius: 12px;
    margin-bottom: 20px;
  }
</style>
<script
  async
  defer
  src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initPickerMap&libraries=places"
></script>
{% endblock %} {% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
  <header class="text-center mb-8">
    <h1 class="text-3xl font-extrabold text-red-600">üö® {{ title }}</h1>
    <p class="text-lg text-gray-600 mt-2">
      ‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
    </p>
  </header>

  <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
    <form method="POST" action="{% url 'report_lost_dog' dog.id %}">
      {% csrf_token %}
      <input
        type="text"
        id="map-search-input"
        placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà..."
        class="input input-bordered w-full mb-4 focus:ring-red-500 focus:border-red-500"
      />
      <div id="lostMapPicker"></div>

      {{ form.lost_latitude }} {{ form.lost_longitude }}

      <div class="form-control mb-4">
        <label class="label"
          ><span class="label-text font-bold"
            >{{ form.lost_location_description.label }}</span
          ></label
        >
        {{ form.lost_location_description }} 
        {% if form.lost_location_description.errors %}<span
          class="text-error text-sm mt-1"
          >{{ form.lost_location_description.errors }}</span
        >{% endif %}
      </div>

      <div class="alert shadow-lg mb-6">
        <div>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            class="stroke-info flex-shrink-0 w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <div>
            <h3 class="font-bold">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</h3>
            <div class="text-xs">
              ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (Lat): <span id="selected_lat">‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
              <span class="mx-2">|</span>
              ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (Lng): <span id="selected_lng"></span>
            </div>
          </div>
        </div>
      </div>

      <button type="submit" class="btn btn-error btn-block btn-lg shadow-lg">
        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢
      </button>
    </form>
  </div>
</div>

<script>
  var pickerMap;
  var pickerMarker;

  // üí° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠ Google API ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
  function initPickerMap() {
    const latInput = document.getElementById("id_lost_latitude");
    const lngInput = document.getElementById("id_lost_longitude");
    const displayLat = document.getElementById("selected_lat");
    const displayLng = document.getElementById("selected_lng");

    // 1. Initial Map Setup
    const initialLat = parseFloat(latInput.value) || 13.736717;
    const initialLng = parseFloat(lngInput.value) || 100.523186;
    const initialPos = { lat: initialLat, lng: initialLng };

    const input = document.getElementById("map-search-input");
    const searchBox = new google.maps.places.SearchBox(input);
    pickerMap = new google.maps.Map(document.getElementById("lostMapPicker"), {
      center: { lat: 13.736717, lng: 100.523186 },
      zoom: 13,
      mapTypeControl: false,
    });
    pickerMap.addListener("bounds_changed", () => {
      searchBox.setBounds(pickerMap.getBounds());
    });
    pickerMarker = new google.maps.Marker({
      position: initialPos,
      map: pickerMap,
      draggable: true, // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏∏‡∏î‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
      title: "‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢",
    });

    searchBox.addListener("places_changed", () => {
      const places = searchBox.getPlaces();
      if (places.length === 0) return;

      // ‡πÉ‡∏ä‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const place = places[0];
      if (!place.geometry || !place.geometry.location) return;

      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();

      // 1. ‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      pickerMap.panTo(place.geometry.location);
      pickerMap.setZoom(17);

      // 2. ‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î
      pickerMarker.setPosition(place.geometry.location);

      // 3. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
      updateCoordinates(lat, lng);
    });

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    updateCoordinates(initialLat, initialLng);

    // 3. Function to Update Form/Display
    function updateCoordinates(lat, lng) {
      latInput.value = lat.toFixed(6);
      lngInput.value = lng.toFixed(6);
      displayLat.textContent = lat.toFixed(6);
      displayLng.textContent = lng.toFixed(6);
    }

    // 4. Handle Marker Drag (‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î)
    pickerMarker.addListener("dragend", (event) => {
      const lat = event.latLng.lat();
      const lng = event.latLng.lng();
      updateCoordinates(lat, lng);
      pickerMap.panTo({ lat: lat, lng: lng }); // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°
    });

    // 5. Handle Map Click (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î)
    pickerMap.addListener("click", (event) => {
      const lat = event.latLng.lat();
      const lng = event.latLng.lng();

      // ‡∏¢‡πâ‡∏≤‡∏¢ Marker ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
      pickerMarker.setPosition(event.latLng);

      updateCoordinates(lat, lng);
      pickerMap.panTo({ lat: lat, lng: lng });
    });
  }
</script>
{% endblock %}
