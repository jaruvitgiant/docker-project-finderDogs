{% extends "base.html" %}
{% load static %}

{% block title %}‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢{% endblock %}

{% block extra_head %}
    <style>
        #lostDogMap {
            height: 700px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>

    <script>
        var map; 
        var markers = {}; 

        // üí° ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô fetchLostDogsData ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡πà‡∏≠‡∏ô initMap ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
        function fetchLostDogsData(infoWindow) {
            const dogListContainer = document.getElementById('dogsListContainer');
            // ... (‡πÇ‡∏Ñ‡πâ‡∏î Fetch Data ‡πÅ‡∏•‡∏∞ Render List/Markers ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ...
            fetch('{% url "lost_dogs_map_data_api" %}')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    const dogs = data.dogs;
                    dogListContainer.innerHTML = ''; 
                    const bounds = new google.maps.LatLngBounds(); 
        
                    if (dogs.length === 0) {
                        dogListContainer.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>';
                        return;
                    }
                    
                    dogs.forEach(dog => {
                        const dogImageUrl = dog.image_url || 'https://via.placeholder.com/40x40?text=DOG'; 
                        const position = { lat: dog.lat, lng: dog.lng };
                        
                        const marker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: dog.name,
                            icon: {
                                url: dogImageUrl,
                                scaledSize: new google.maps.Size(40, 40), 
                                anchor: new google.maps.Point(20, 40), 
                            }
                        });
                        
                        markers[dog.id] = marker;
                        bounds.extend(position); 
        
                        const infoWindow = new google.maps.InfoWindow(); // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á InfoWindow ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô initMap ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                        const infoContent = `
                            <div class="p-2">
                                <div class="text-center font-bold text-red-600">üö® ${dog.name} ‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢!</div>
                                <div class="mt-1 text-sm text-gray-700">Lat: ${dog.lat.toFixed(4)}, Lng: ${dog.lng.toFixed(4)}</div>
                                <a href="${dog.detail_url}" class="btn btn-sm btn-block btn-error mt-3">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
                            </div>
                        `;
        
                        marker.addListener("click", () => {
                            infoWindow.setContent(infoContent);
                            infoWindow.open(map, marker);
                        });
        
                        const listItem = document.createElement('div');
                        listItem.className = 'list-item card card-side bg-base-100 shadow-md cursor-pointer hover:bg-gray-100 transition duration-150 border border-gray-200';
                        listItem.innerHTML = `
                            <figure class="w-16 h-16 m-2 rounded-lg overflow-hidden">
                                <img src="${dogImageUrl}" alt="${dog.name}" class="object-cover w-full h-full"/>
                            </figure>
                            <div class="card-body p-3 flex flex-col justify-center">
                                <p class="text-sm font-bold text-red-600">${dog.name}</p>
                                <p class="text-xs text-gray-500">Lat: ${dog.lat.toFixed(4)}, Lng: ${dog.lng.toFixed(4)}</p>
                            </div>
                        `;
                        
                        listItem.addEventListener('click', () => {
                            const selectedMarker = markers[dog.id];
                            map.panTo(selectedMarker.getPosition()); 
                            map.setZoom(12); 
                            
                            infoWindow.setContent(infoContent);
                            infoWindow.open(map, selectedMarker);
                        });
        
                        dogListContainer.appendChild(listItem);
                    });
        
                    if (dogs.length > 0) {
                        map.fitBounds(bounds);
                    }
                })
                .catch(error => {
                    console.error('Error fetching lost dog data:', error);
                    dogListContainer.innerHTML = '<p class="text-error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</p>';
                });
        }
        
        function initMap() {
            // --- 1. Initialize Map ---
            map = new google.maps.Map(document.getElementById("lostDogMap"), {
                center: { lat: 13.736717, lng: 100.523186 }, 
                zoom: 10,
                mapTypeControl: false, 
            });
        
            // --- 2. Initialize Geosearch (SearchBox) ---
            const input = document.getElementById("map-search-input");
            const searchBox = new google.maps.places.SearchBox(input);
            const infoWindow = new google.maps.InfoWindow(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á InfoWindow instance ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        
            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });
        
            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) return;
        
                const bounds = new google.maps.LatLngBounds();
                places.forEach((place) => {
                    if (!place.geometry || !place.geometry.location) return;
                    
                    if (place.geometry.viewport) {
                        bounds.union(place.geometry.viewport);
                    } else {
                        bounds.extend(place.geometry.location);
                    }
                });
                map.fitBounds(bounds);
            });
            
            fetchLostDogsData(infoWindow);
        }
    </script>
    
    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap&libraries=places"></script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢</h1>
    
    <div class="flex flex-col md:flex-row gap-6">
        
        <div id="dogListSidebar" class="w-full md:w-1/4 bg-white p-4 rounded-xl shadow-lg border border-gray-100 overflow-y-auto" style="height: 700px;">
            <input type="text" id="map-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà..." 
                   class="input input-bordered w-full mb-4 focus:ring-red-500 focus:border-red-500">

            <h2 class="text-xl font-bold mb-4 text-indigo-700">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢</h2>
            <div id="dogsListContainer" class="space-y-3">
                <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</p>
            </div>
        </div>

        <div id="lostDogMap" class="w-full md:w-3/4"></div>

    </div>
</div>
{% endblock %}

{% block scripts %}
{% endblock %}