
{% extends "admin/baseAI.html" %}
{% block title%} AI Management Dashboard  {% endblock %}
{% block content %}
<!-- Historical Test Data Section & Available Models Section -->
    <div class="flex justify-center">
        <div class="w-full lg:w-3/4">
            <!-- Left: Historical Test Data Table -->
            <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4 flex-none">
                <h2 class="text-xl font-bold text-white flex items-center">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ประวัติการทดสอบ
                </h2>
                <p class="text-purple-100 text-sm mt-1">ดูประวัติการทดสอบทั้งหมด (สามารถเลื่อนได้)</p>
            </div>
            <!-- ปุ่มลบทั้งหมด -->
            {% if test_history %}
            <div class="px-6 py-3 bg-red-50 border-b border-red-200 flex justify-end gap-2">
                <button onclick="deleteAllHistory()" 
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition-colors font-semibold text-sm">
                    ลบประวัติทั้งหมด
                </button>
            </div>
            {% endif %}
            <div class="overflow-x-auto overflow-y-auto flex-1" style="max-height: 500px;">
                <table class="w-full table-auto">
                    <thead class="bg-gray-100 border-b border-gray-200 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">#</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">วันที่</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Model</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Embedding</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ความแม่นยำ</th>
                            <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">ดำเนินการ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% if test_history %}
                            {% for result in test_history %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{ forloop.counter }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-600">
                                    <div class="font-medium">{{ result.created_at|date:"d/m/Y" }}</div>
                                    <div class="text-gray-500">{{ result.created_at|time:"H:i" }}</div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs">
                                    <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-semibold bg-amber-100 text-amber-800">
                                        {{ result.model_name }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ result.count }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <div class="flex items-center gap-1">
                                        <div class="w-12 bg-gray-200 rounded-full h-1 mr-1">
                                            <div class="bg-green-500 h-1 rounded-full" style="width: {{ result.accuracy|default:0 }}%"></div>
                                        </div>
                                        <span class="text-xs font-bold text-gray-900 w-10">{{ result.accuracy|floatformat:2 }}%</span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-center">
                                    <div class="flex gap-2 justify-center">

                                        <button onclick="deleteHistory({{ result.id }})" 
                                                class="bg-red-50 text-red-600 hover:bg-red-100 px-2 py-1 rounded transition-colors font-semibold text-xs border border-red-200">
                                            ลบ
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="px-4 py-12 text-center text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <svg class="w-12 h-12 text-gray-200 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <p class="text-base font-medium">ยังไม่มีประวัติ</p>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Form ซ่อนสำหรับส่งค่า -->
        <form id="deleteForm" method="POST" style="display: none;">
            {% csrf_token %}
            <input type="hidden" name="action" id="deleteAction">
            <input type="hidden" name="result_id" id="deleteResultId">
        </form>
    </div>
    </div>

    <!-- Modal Confirm Delete -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-4">
            <h3 class="text-lg font-bold text-gray-900 mb-2">ยืนยันการลบ</h3>
            <p class="text-gray-600 mb-6" id="deleteConfirmMessage">คุณแน่ใจหรือว่าต้องการลบประวัตินี้?</p>
            <div class="flex gap-3 justify-end">
                <button onclick="closeDeleteConfirm()" 
                        class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded transition-colors">
                    ยกเลิก
                </button>
                <button onclick="confirmDelete()" 
                        class="px-4 py-2 text-white bg-red-500 hover:bg-red-600 rounded transition-colors font-semibold">
                    ลบ
                </button>
            </div>
        </div>
    </div>
    <script>
function deleteHistory(resultId) {
    document.getElementById('deleteAction').value = 'delete_single';
    document.getElementById('deleteResultId').value = resultId;
    document.getElementById('deleteConfirmMessage').textContent = 'คุณแน่ใจหรือว่าต้องการลบประวัตินี้?';
    document.getElementById('deleteConfirmModal').classList.remove('hidden');
}

function deleteAllHistory() {
    document.getElementById('deleteAction').value = 'delete_all';
    document.getElementById('deleteResultId').value = '';
    document.getElementById('deleteConfirmMessage').textContent = 'คุณแน่ใจหรือว่าต้องการลบประวัติการทดสอบทั้งหมด? การดำเนินการนี้ไม่สามารถคืนได้';
    document.getElementById('deleteConfirmModal').classList.remove('hidden');
}

function closeDeleteConfirm() {
    document.getElementById('deleteConfirmModal').classList.add('hidden');
}

function confirmDelete() {
    document.getElementById('deleteForm').submit();
}

function showResultDetail(resultId, event) {
    event.preventDefault();
    // สำหรับแสดง detail ของผลการทดสอบ (สามารถเพิ่มการเรียก API หรือแสดง Modal)
    alert('คลิกที่ ID: ' + resultId);
}
</script>

{% endblock %}